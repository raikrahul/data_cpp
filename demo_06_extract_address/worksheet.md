```
═══════════════════════════════════════════════════════════════════════════════
DEMO 06: EXTRACT PHYSICAL ADDRESS - WORKSHEET
═══════════════════════════════════════════════════════════════════════════════
Machine: AMD Ryzen 5 4600H | Phys=44 bits
═══════════════════════════════════════════════════════════════════════════════

PROBLEM 1: MASK COMPARISON BY PAGE SIZE
─────────────────────────────────────────────────────────────────────────────────

┌─────────────────────────────────────────────────────────────────────────────┐
│ PAGE SIZE │ MASK VALUE           │ ADDRESS BITS │ OFFSET BITS           │
├───────────┼──────────────────────┼──────────────┼───────────────────────│
│ 4 KB      │ 0x000FFFFFFFFFF000   │ [51:12] = 40 │ [11:0]  = 12 bits     │
│ 2 MB      │ 0x000FFFFFFFE00000   │ [51:21] = 31 │ [20:0]  = 21 bits     │
│ 1 GB      │ 0x000FFFFFC0000000   │ [51:30] = 22 │ [29:0]  = 30 bits     │
└───────────┴──────────────────────┴──────────────┴───────────────────────┘

DERIVE 4KB MASK:
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4KB = 4096 = 2^12 → offset = 12 bits                                       │
│ Address starts at bit 12, ends at bit 51 (40 bits = 1TB theoretical)       │
│ Bits 63-52 = reserved (zeroed)                                             │
│ Bits 11-0 = offset (zeroed in mask)                                        │
│                                                                             │
│ Mask = (2^52 - 2^12) = 0x000FFFFFFFFFF000                                  │
│ Verify: 2^52 = 0x10000000000000                                            │
│         2^12 = 0x1000                                                       │
│         Difference = 0x000FFFFFFFFFF000 ✓                                  │
└─────────────────────────────────────────────────────────────────────────────┘

DERIVE 2MB MASK:
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2MB = 2,097,152 = 2^21 → offset = 21 bits                                  │
│ Address starts at bit 21, ends at bit 51 (31 bits)                         │
│                                                                             │
│ Mask = (2^52 - 2^21) = ?                                                   │
│ 2^52 = 4,503,599,627,370,496 = 0x10000000000000                            │
│ 2^21 = 2,097,152 = 0x200000                                                │
│ Difference = 4,503,599,627,370,496 - 2,097,152                             │
│            = 4,503,599,625,273,344                                          │
│            = 0x000FFFFFFFE00000 ✓                                          │
└─────────────────────────────────────────────────────────────────────────────┘

DERIVE 1GB MASK:
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1GB = 1,073,741,824 = 2^30 → offset = 30 bits                              │
│ Address starts at bit 30, ends at bit 51 (22 bits)                         │
│                                                                             │
│ Mask = (2^52 - 2^30)                                                       │
│ 2^30 = 1,073,741,824 = 0x40000000                                          │
│ Difference = 0x10000000000000 - 0x40000000 = 0x000FFFFFC0000000 ✓         │
└─────────────────────────────────────────────────────────────────────────────┘

─────────────────────────────────────────────────────────────────────────────────
PROBLEM 2: EXTRACT ADDRESS FROM ENTRY
─────────────────────────────────────────────────────────────────────────────────

Given: Entry = 0x80000002FAE00067

CASE 4KB:
┌─────────────────────────────────────────────────────────────────────────────┐
│ phys = 0x80000002FAE00067 & 0x000FFFFFFFFFF000                             │
│                                                                             │
│ High nibble: 0x8 & 0x0 = 0                                                 │
│ Next 11 zeros: stay 0                                                       │
│ Mid: 0x00002FAE00 stays (matches F mask)                                   │
│ Low 3 nibbles: 0x067 & 0x000 = 0                                           │
│                                                                             │
│ Result = 0x00000002FAE00000                                                │
│ Physical address = _____ (fill in)                                         │
└─────────────────────────────────────────────────────────────────────────────┘

CASE 2MB (if PS=1 at PD level):
┌─────────────────────────────────────────────────────────────────────────────┐
│ phys = 0x80000002FAE00067 & 0x000FFFFFFFE00000                             │
│                                                                             │
│ Same high bits zeroed                                                       │
│ 0x...E00000: mask zeros out bits [20:0]                                    │
│ 0xFAE00000 & 0xFFE00000 = 0xFAE00000                                       │
│                                                                             │
│ Result = 0x00000002FAE00000 (same in this case - already 2MB aligned)      │
└─────────────────────────────────────────────────────────────────────────────┘

─────────────────────────────────────────────────────────────────────────────────
PROBLEM 3: MISUSE OF WRONG MASK
─────────────────────────────────────────────────────────────────────────────────

Given: Entry = 0x80000002FAF45067 (NOT 2MB aligned)
This is a 4KB entry that points to physical 0x2FAF45000

CORRECT (4KB):
┌─────────────────────────────────────────────────────────────────────────────┐
│ phys = 0x80000002FAF45067 & 0x000FFFFFFFFFF000                             │
│      = 0x00000002FAF45000 ✓                                                │
└─────────────────────────────────────────────────────────────────────────────┘

WRONG (using 2MB mask on 4KB entry):
┌─────────────────────────────────────────────────────────────────────────────┐
│ phys = 0x80000002FAF45067 & 0x000FFFFFFFE00000                             │
│                                                                             │
│ 0xF45000 in bits [20:0] gets zeroed!                                       │
│ 0xF45 = 3909 pages lost                                                    │
│                                                                             │
│ Result = 0x00000002FAE00000 ← WRONG!                                       │
│ Error = 0x145000 bytes = 1,331,200 bytes = 1.27 MB offset lost            │
└─────────────────────────────────────────────────────────────────────────────┘

─────────────────────────────────────────────────────────────────────────────────
PROBLEM 4: HARDER EXAMPLE
─────────────────────────────────────────────────────────────────────────────────

Given: Entry = 0x80000007FFFFF1E3 (unusual pattern)

EXTRACT 4KB ADDRESS:
┌─────────────────────────────────────────────────────────────────────────────┐
│ phys = 0x80000007FFFFF1E3 & 0x000FFFFFFFFFF000                             │
│                                                                             │
│ Step-by-step:                                                               │
│ 0x8... & 0x0... = 0x0 (NX bit removed)                                     │
│ 0x...7FFFFF1E3 & 0x...FFFFFFFFFF000 = ?                                    │
│                                                                             │
│ 0x7FFFFF1E3:                                                                │
│ Low 3 hex: 1E3 & 000 = 000                                                 │
│ Rest: 7FFFFF stays                                                          │
│                                                                             │
│ Result = 0x00000007FFFFF000                                                │
│                                                                             │
│ Verify: Is this 4KB aligned? Ends in 000 ✓                                │
│ Is this valid for 44-bit system? 0x7FFFFF000 = 34 bits used ✓            │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
ANSWERS
═══════════════════════════════════════════════════════════════════════════════

Problem 2: 0x00000002FAE00000
Problem 4: 0x00000007FFFFF000

═══════════════════════════════════════════════════════════════════════════════
FAILURE PREDICTIONS
═══════════════════════════════════════════════════════════════════════════════

F1. Using 4KB mask for 2MB page → keep garbage in bits [20:12]
F2. Using 2MB mask for 4KB page → lose valid address bits [20:12]
F3. Forgetting to mask bit 63 (NX) → address looks huge/invalid
F4. Using address without __va() → crash (physical vs virtual)
F5. Not checking page size before choosing mask → wrong address
```
